/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/deepExtend","sap/base/util/extend","sap/ui/model/ChangeReason","sap/ui/model/Context","sap/ui/model/ContextBinding"],function(e,t,i,n,o){"use strict";var s=o.extend("sap.ui.model.odata.v2.ODataContextBinding",{constructor:function(t,i,n,s,a){o.call(this,t,i,n,s,a);this.sRefreshGroupId=undefined;this.bPendingRequest=false;this.mParameters=e({},this.mParameters);this.bCreatePreliminaryContext=this.mParameters.createPreliminaryContext||t.bPreliminaryContext;this.bUsePreliminaryContext=this.mParameters.usePreliminaryContext||t.bPreliminaryContext;this.mParameters.createPreliminaryContext=this.bCreatePreliminaryContext;this.mParameters.usePreliminaryContext=this.bUsePreliminaryContext;this.bPendingRequest=false}});s.prototype.initialize=function(){var e=this,t,o=this.isRelative()&&this.oContext&&this.oContext.bCreated,s=this.oContext&&this.oContext.isPreliminary(),a;if(!this.oModel.oMetadata.isLoaded()||!this.bInitial){return}this.bInitial=false;if(s&&!this.bUsePreliminaryContext){return}t=this.getResolvedPath();if(!t||o){this.oElementContext=null;this._fireChange({reason:i.Context});return}a=this.oModel._isReloadNeeded(t,this.mParameters);if(a){this.fireDataRequested();this.bPendingRequest=true}var r=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(t){var o,s=t&&t.isUpdated(),r=t&&t.isRefreshForced();if(e.bCreatePreliminaryContext&&t&&e.oElementContext){e.oElementContext.setPreliminary(false);e.oModel._updateContext(e.oElementContext,t.getPath());e._fireChange({reason:i.Context},false,true)}else if(!t||n.hasChanged(t,e.oElementContext)){e.oElementContext=t;e._fireChange({reason:i.Context},r,s)}if(a){if(e.oElementContext){o=e.oElementContext.getObject(e.mParameters)}e.oModel.callAfterUpdate(function(){e.fireDataReceived({data:o})});e.bPendingRequest=false}},a);if(r){if(this.bCreatePreliminaryContext&&this.oElementContext!==r){r.setPreliminary(true);this.oElementContext=r;this.oModel.oMetadata.loaded().then(function(){this._fireChange({reason:i.Context})}.bind(this))}}else if(this.oContext){this.oElementContext=null;this._fireChange({reason:i.Context})}};s.prototype.checkUpdate=function(){var e,t=this.mParameters,n=this.oContext&&this.oContext.isPreliminary();if(this.bInitial||this.bPendingRequest){return}if(this.oContext&&this.oContext.isUpdated()){this.setContext(this.oContext);return}if(n&&!this.bUsePreliminaryContext){return}if(t.createPreliminaryContext){t=Object.assign({},t);delete t.createPreliminaryContext}e=this.oModel.createBindingContext(this.sPath,this.oContext,t);if(e!==undefined&&e!==this.oElementContext){this.oElementContext=e;this._fireChange({reason:i.Context})}};s.prototype.refresh=function(e,t){if(typeof e==="string"){t=e;e=false}this.sRefreshGroupId=t;this._refresh(e);this.sRefreshGroupId=undefined};s.prototype._refresh=function(e,o){var s=this,a,r,h,l=false,C=this.mParameters,x=this.isRelative()&&this.oContext&&this.oContext.bCreated,f=this.getResolvedPath(),d;if(this.bInitial||x){return}if(o){h=this.oModel._getObject(this.sPath,this.oContext);if(h){r=this.oModel._getKey(h);if(r in o){l=true}}}else{l=true}if(e||l){if(f){this.fireDataRequested();this.bPendingRequest=true}if(this.sRefreshGroupId){C=t({},this.mParameters);C.groupId=this.sRefreshGroupId}var m=this.oModel.createBindingContext(this.sPath,this.oContext,C,function(t){if(s.bCreatePreliminaryContext&&t&&s.oElementContext){s.oElementContext.setPreliminary(false);s.oModel._updateContext(s.oElementContext,t.getPath());s._fireChange({reason:i.Context},false,true)}else if(n.hasChanged(t,s.oElementContext)||e){s.oElementContext=t;s._fireChange({reason:i.Context},e)}if(s.oElementContext){a=s.oElementContext.getObject(s.mParameters)}if(f){s.oModel.callAfterUpdate(function(){s.fireDataReceived({data:a})});s.bPendingRequest=false}},true);if(m&&this.bCreatePreliminaryContext){if(this.oElementContext!==m||e){m.setPreliminary(true);this.oElementContext=m;d=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,f);this._fireChange({reason:i.Context},e);this.oModel._updateContext(this.oElementContext,d)}}}};s.prototype.setContext=function(e){var t=this,o,s,a,r=e&&e.bCreated,h=e&&e.isPreliminary(),l=e&&e.isRefreshForced(),C=e&&e.isUpdated(),x,f;if(this.bInitial||!this.isRelative()){return}if(h&&!this.bUsePreliminaryContext){return}if(C&&this.bUsePreliminaryContext){this._fireChange({reason:i.Context});return}if(n.hasChanged(this.oContext,e)){this.oContext=e;a=this.getResolvedPath();if(!a||r){if(this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:i.Context})}return}s=this.oModel._getObject(this.sPath,this.oContext);f=l||this.oModel._isReloadNeeded(a,this.mParameters);if(a&&f){this.fireDataRequested();this.bPendingRequest=true}o=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(e){if(t.bCreatePreliminaryContext&&e&&t.oElementContext){t.oElementContext.setPreliminary(false);t.oModel._updateContext(t.oElementContext,e.getPath());t._fireChange({reason:i.Context},false,true)}else if(n.hasChanged(e,t.oElementContext)){t.oElementContext=e;t._fireChange({reason:i.Context},l,C)}if(a&&f){if(t.oElementContext){s=t.oElementContext.getObject(t.mParameters)}t.oModel.callAfterUpdate(function(){t.fireDataReceived({data:s})});t.bPendingRequest=false}},f);if(o){if(this.bCreatePreliminaryContext){o.setPreliminary(true);this.oElementContext=o;x=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,a);this._fireChange({reason:i.Context},l);this.oModel._updateContext(this.oElementContext,x)}}else if(this.oContext&&this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:i.Context})}}};s.prototype._fireChange=function(e,t,i){if(this.oElementContext){this.oElementContext.setForceRefresh(t);this.oElementContext.setUpdated(i)}o.prototype._fireChange.call(this,e);if(this.oElementContext){this.oElementContext.setForceRefresh(false);this.oElementContext.setUpdated(false)}};return s});