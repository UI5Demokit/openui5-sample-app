/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObjectMetadata","sap/ui/core/ComponentContainer","sap/ui/core/Placeholder","sap/ui/core/library"],function(e,t,o,n,i){"use strict";var r=i.ComponentLifecycle;return{display:function(e){var t=Promise.resolve();return this._display(e,t)},_display:function(e,t,o){if(this._oParent){t=this._oParent._display(e,t,Object.assign({},o))}return this._place(e,t,o)},suspend:function(){if(this._oParent){this._oParent.suspend()}if(this._isLoaded()){var t=this._get(),o;if(t.isA("sap.ui.core.UIComponent")&&(o=t.getRouter())&&t.hasNativeRouter()){o.stop()}}else{e.warning("The target with name '"+this._oOptions._name+"' can't be suspended because it's being loaded or not loaded yet")}return this},_isLoaded:function(){return this._bIsLoaded},_getCreateOptions:function(e){var t=this._getEffectiveObjectName(this._oOptions.name),o=this._oOptions,n;e=e||{};switch(o.type){case"View":n={name:t,type:o.viewType,id:o.id,async:true};break;case"Component":n={id:o.id};if(o.usage){n.usage=o.usage}else{n.name=t}n=Object.assign({},o.options||{},n);break;default:throw new Error("The given type "+o.type+" isn't support by sap.ui.core.routing.Target")}return n},_get:function(e){var t=this._getCreateOptions(e);return this._oCache._get(t,this._oOptions.type,this._bUseRawViewId,e)},_load:function(e){var t=this._get(e),o;if(!(t instanceof Promise)){if(t.isA("sap.ui.core.mvc.View")){o=t.loaded()}else{o=Promise.resolve(t)}}else{o=t}return o.then(function(e){this._bIsLoaded=true;return e}.bind(this))},_place:function(i,a,s){if(i instanceof Promise){s=a;a=i;i=undefined}var c=this._oOptions,l=this,d,u,h,f=true,p,g,_=c.type==="Component";s=s||{};if((c.name||c.usage)&&c.type){g=new Promise(function(e){p=e});if(_){s.componentId=l._oOptions.id||t.uid("uicomponent")}h=this._load(s).then(function(e){if(e.isA("sap.ui.core.UIComponent")){var t=e.getRouter();if(t&&e.hasNativeRouter()){var o=t.getHashChanger().getHash();var n=t.getRouteByHash(o);var i=s&&s.ignoreInitialHash;if(!t._oConfig.async){throw new Error("The router of component '"+e.getId()+"' which is loaded via the target '"+l._oOptions._name+"' is defined as synchronous which is not supported using as a nested component.")}if(t._oOwner&&s){t._oOwner._bRoutingPropagateTitle=s.propagateTitle}if(!i&&(!t.isInitialized()||t._bMatchingProcessStarted)&&n&&n._oConfig.target){f=false;t.attachRouteMatched(p)}if(t.isStopped()){t.initialize(i)}}}if(f){p()}return e});a=a.then(function(e){e=e||{};var t=l._isValid(e);if(t!==true){u=t;return l._refuseInvalidTarget(c._name,u)}var o=e.view,n=e.control,i,r;if(o&&o.isA("sap.ui.core.ComponentContainer")){o=o.getComponentInstance().getRootControl()}if(!o&&c.rootView){i=Promise.resolve(c.rootView).then(function(e){var t;if(e){t=sap.ui.getCore().byId(e);c.rootView=e}if(!t){u="Did not find the root view with the id "+c.rootView;return l._refuseInvalidTarget(c._name,u)}else{return t}})}else{i=Promise.resolve(o)}i=i.then(function(e){if(e&&e.isA("sap.ui.core.mvc.View")){return e.loaded()}else{return e}});if(c.controlId){r=i.then(function(e){var t;if(e){t=e.byId(c.controlId)}if(!t){t=sap.ui.getCore().byId(c.controlId)}return t})}else{r=Promise.resolve(n)}return r.then(function(e){if(!e){u="Control with ID "+c.controlId+" could not be found";return l._refuseInvalidTarget(c._name,u)}else{return e}})}).then(function(e){var t=false;var i=s.placeholder||l._oOptions.placeholder||{};if(n.hasProviders()){Object.assign(i,n.getPlaceholderFromProviders({name:l._oOptions.name,type:l._oOptions.type}))}if(Object.keys(i).length>0){if(i.autoClose===undefined){i.autoClose=true}t=true}if(_){var a=l._oCache._oComponent;var u=s.componentId+"-container";d=a&&a.byId(u)||sap.ui.getCore().byId(u);if(!d){var h=Object.assign({height:"100%",width:"100%",lifecycle:r.Application},c.containerOptions);if(a){a.runAsOwner(function(){d=new o(a.createId(u),h)})}else{d=new o(u,h)}}if(t){i.container=d}}if(t&&e.isA("sap.ui.core.IPlaceholderSupport")){i.container=e}if(i.container){i.aggregation=l._oOptions.controlAggregation;if(!s.repeatedRoute){var f=l._getCreateOptions(s);var p=l._oCache.fetch(f,l._oOptions.type);if(p&&_){i.object=d}else{i.object=p}}if(i.html){i.placeholder=new n({html:i.html})}if(i.placeholder){l.showPlaceholder(i)}}return{containerControl:e,object:d,placeholderConfig:i}}).then(function(e){return h.then(function(t){var o,n;if(_){var i=t.destroy;t.destroy=function(){if(i){i.apply(this)}e.object.destroy()};e.object.setComponent(t);n=t.getRootControl();if(n&&n.isA("sap.ui.core.mvc.View")){o=n}}else{e.object=t;o=t}l._bindTitleInTitleProvider(o);l._addTitleProviderAsDependent(o);return e})}).then(function(t){var o=t.containerControl,n=t.object;l._beforePlacingViewIntoContainer({container:o,view:n,data:i});var r=o.getMetadata().getJSONKeys()[c.controlAggregation];if(!r){u="Control "+c.controlId+" does not have an aggregation called "+c.controlAggregation;return l._refuseInvalidTarget(c._name,u)}if(c.clearControlAggregation===true){o[r._sRemoveAllMutator]()}e.info("Did place the "+c.type.toLowerCase()+" target '"+(c.name?l._getEffectiveObjectName(c.name):c.usage)+"' with the id '"+n.getId()+"' into the aggregation '"+c.controlAggregation+"' of a control with the id '"+o.getId()+"'",l);o[r._sMutator](n);return{name:c._name,view:n,control:o,placeholderConfig:t.placeholderConfig}})}else{a=a.then(function(){return{name:c._name}})}return Promise.all([a,g]).then(function(e){var t=e[0].control;var o=e[0].view;if(t&&o){l.fireDisplay({view:o.isA("sap.ui.core.mvc.View")?o:undefined,object:o,control:t,config:l._oOptions,data:i,routeRelevant:s.routeRelevant})}if(e[0].placeholderConfig&&e[0].placeholderConfig.container&&l.hidePlaceholder&&e[0].placeholderConfig.autoClose){l.hidePlaceholder(e[0].placeholderConfig)}return e[0]})},showPlaceholder:function(e){if(e.container&&e.container.showPlaceholder){e.container.showPlaceholder(e)}},hidePlaceholder:function(e){if(e.container.hidePlaceholder){e.container.hidePlaceholder()}},_isValid:function(t){var o=this._oOptions,n=t&&t.control,i=n||o.controlId,r=true,a="";if(!i){a="The target "+o._name+" has no controlId set and no parent so the target cannot be displayed.";r=false}if(!o.controlAggregation){a="The target "+o._name+" has a control id or a parent but no 'controlAggregation' was set, so the target could not be displayed.";r=false}if(a){e.error(a,this)}return r||a},_refuseInvalidTarget:function(e,t){return Promise.reject(new Error(t+" - Target: "+e))}}});