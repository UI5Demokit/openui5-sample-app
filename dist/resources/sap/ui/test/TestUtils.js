/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.sjax","sap/base/Log","sap/base/util/merge","sap/base/util/UriParameters","sap/ui/core/Core"],function(e,t,r,n){"use strict";var s=/\/\$batch($|\?)/,a=/(?:^|\r\n)Content-Id\s*:\s*(\S+)/i,i=/^(.*)?:\s*(.*)$/,o="application/json;charset=UTF-8;IEEE754Compatible=true",u={},c="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n",f=/^Content-Type:\s*multipart\/mixed;\s*boundary=/i,p=n.fromQuery(window.location.search),d=p.get("autoRespondAfter"),l=p.get("realOData"),h=/^(\S+) (\S+)$/,y=/^(GET|DELETE|MERGE|PATCH|POST) (\S+) HTTP\/1\.1$/,g={},m=/^(OData-Version|DataServiceVersion)$/,E=l==="true"||l==="direct",T=0,v=p.get("supportAssistant")==="true",x;if(E){document.title=document.title+" (real OData)"}function b(e,t,r){var n=QUnit.objectType(e),s=QUnit.objectType(t),a;if(n==="string"&&s==="regexp"){if(!t.test(e)){throw new Error(r+": actual value "+e+" does not match expected regular expression "+t)}return}if(n!==s){throw new Error(r+": actual type "+n+" does not match expected type "+s)}if(n==="array"){if(e.length<t.length){throw new Error(r+": array length: "+e.length+" < "+t.length)}}if(n==="array"||n==="object"){for(a in t){b(e[a],t[a],r==="/"?r+a:r+"/"+a)}}else if(e!==t){throw new Error(r+": actual value "+e+" does not match expected value "+t)}}function C(e,t,r,n){try{b(e,t,"/");QUnit.assert.pushResult({result:n,actual:e,expected:t,message:r})}catch(s){QUnit.assert.pushResult({result:!n,actual:e,expected:t,message:(r||"")+" failed because of "+s.message})}}x={awaitRendering:function(){if(sap.ui.getCore().getUIDirty()){return new Promise(function(e){function t(){if(sap.ui.getCore().getUIDirty()){setTimeout(t,1)}else{e()}}t()})}},checkError:function(e,t,r,n){e.strictEqual(t.constructor,r);e.strictEqual(t.message,n);e.strictEqual(t.name,r.name)},deepContains:function(e,t,r){C(e,t,r,true)},notDeepContains:function(e,t,r){C(e,t,r,false)},useFakeServer:function(n,p,l,h,g){var E,v;function x(t,r){var n=H(t,r.requestBody),s=S(r);T+=1;r.respond(200,e.extend({},s,{"Content-Type":"multipart/mixed;boundary="+n.boundary}),q(n,s))}function b(e){var t={buildResponse:e.buildResponse,code:e.code||200,headers:e.headers||{},ifMatch:e.ifMatch};if(e.source){t.message=L(p+e.source);t.headers["Content-Type"]=t.headers["Content-Type"]||R(e.source)}else if(typeof e.message==="object"){t.headers["Content-Type"]=o;t.message=JSON.stringify(e.message)}else{t.message=e.message}return t}function C(){var e,t,r={};for(t in l){e=l[t];if(!t.includes(" ")){t="GET "+t}if(Array.isArray(e)){r[t]=e.map(b)}else{r[t]=[b(e)]}}return r}function R(e){if(/\.xml$/.test(e)){return"application/xml"}if(/\.json$/.test(e)){return o}return"application/x-octet-stream"}function D(e,r,n){t.error(r.requestLine,n,"sap.ui.test.TestUtils");return{code:e,headers:{"Content-Type":"text/plain"},message:n}}function O(e){return e.slice(0,e.indexOf("\r\n"))}function q(e,t){var r=[""];e.parts.every(function(e){r.push(e.boundary?"\r\nContent-Type: multipart/mixed;boundary="+e.boundary+"\r\n\r\n"+q(e,t):w(e,t));return!e.code||e.code<400||t.DataServiceVersion==="2.0"});r.push("--\r\n");return r.join("--"+e.boundary)}function w(t,r){var n=e.extend({},r,t.headers);return c+(t.contentId?"Content-ID: "+t.contentId+"\r\n":"")+"\r\nHTTP/1.1 "+t.code+" \r\n"+Object.keys(n).map(function(e){return e+": "+n[e]}).join("\r\n")+"\r\n\r\n"+(t.message||"")+"\r\n"}function M(e,r){var n,s,a=e+" "+r;if(v[a]){return{responses:v[a]}}if(!E){return undefined}n=[];s=E.filter(function(e){var t=a.match(e.regExp);if(t){n.push(t)}return t});if(s.length>1){t.warning("Multiple matches found for "+a,undefined,"sap.ui.test.TestUtils");return undefined}return s.length?{responses:s[0].response,match:n[0]}:undefined}function S(e){var t,r={};for(t in e.requestHeaders){if(m.test(t)){r[t]=e.requestHeaders[t]}}return r}function A(n,s){var a,i=M(n.method,n.url),u,c=i&&i.responses;c=(c||[]).filter(function(e){if(typeof e.ifMatch==="function"){return e.ifMatch(n)}return!e.ifMatch||e.ifMatch.test(n.requestBody)});if(c.length){u=c[0];if(typeof u.buildResponse==="function"){u=r({},u);u.buildResponse(i.match,u)}if(i.responses.length>1){a=i.responses.indexOf(u)}}else{switch(n.method){case"HEAD":u={code:200};break;case"DELETE":case"MERGE":case"PATCH":u={code:204};break;case"POST":u={code:200,headers:{"Content-Type":o},message:n.requestBody};break}}if(u){t.info(n.method+" "+n.url+(a!==undefined?", alternative (ifMatch) #"+a:""),'{"If-Match":'+JSON.stringify(n.requestHeaders["If-Match"])+"}","sap.ui.test.TestUtils")}else{u=D(404,n,"No mock data found")}u.headers=e.extend({},S(n),u.headers);if(s&&u.code<300){u.contentId=s}return u}function H(e,t){var r;t=t.replace(/^\s+/,"");r=O(t);return{boundary:O(t).slice(2),parts:t.split(r).slice(1,-1).map(function(t){var r,n,s,i,o,u;t=t.slice(2);n=O(t);if(f.test(n)){i=H(e,t.slice(n.length+4));r=i.parts.filter(function(e){return e.code>=300});return r.length?r[0]:i}u=t.indexOf("\r\n\r\n")+4;o=j(e,t.slice(u));s=a.exec(t.slice(0,u));return A(o,s&&s[1])})}}function j(e,t){var r=t.indexOf("\r\n\r\n"),n,s,a={requestHeaders:{}};a.requestBody=t.slice(r+4,t.length-2);t=t.slice(0,r);n=t.split("\r\n");a.requestLine=n.shift();s=y.exec(a.requestLine);if(s){a.method=s[1];a.url=e+s[2];n.forEach(function(e){var t=i.exec(e);if(t){a.requestHeaders[t[1]]=t[2]}})}return a}function k(e){var t=e.url;if(s.test(t)){x(t.slice(0,t.indexOf("/$batch")+1),e)}else{U(e)}}function L(t){var r=u[t];if(!r){e.ajax({async:false,url:t,dataType:"text",success:function(e){r=e}});if(!r){throw new Error(t+": resource not found")}u[t]=r}return r}function U(e){var t=A(e);T+=1;e.respond(t.code,t.headers,t.message)}function P(){var t,r;v=C();if(h){E=h.map(function(e){return{regExp:e.regExp,response:Array.isArray(e.response)?e.response.map(b):[b(e.response)]}})}r=sinon.fakeServer.create();n.add(r);r.autoRespond=true;if(d){r.autoRespondAfter=parseInt(d)}r.respondWith("GET",/./,U);r.respondWith("DELETE",/./,U);r.respondWith("HEAD",/./,U);r.respondWith("PATCH",/./,U);r.respondWith("MERGE",/./,U);r.respondWith("POST",/./,k);t=r.restore;r.restore=function(){sinon.FakeXMLHttpRequest.filters=[];t.apply(this,arguments)};sinon.xhr.supportsCORS=e.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(e,t){var r=M(e,t)||(g?t.startsWith(g)||s.test(t):e==="DELETE"||e==="HEAD"||e==="MERGE"||e==="PATCH"||e==="POST");return!r})}p=sap.ui.require.toUrl(p).replace(/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,"$1test-resources/")+"/";P()},withNormalizedMessages:function(e){var t=sinon.sandbox.create();try{var r=sap.ui.getCore(),n=r.getLibraryResourceBundle;t.stub(r,"getLibraryResourceBundle").returns({getText:function(e,t){var s=e,a=n.call(r).getText(e),i;for(i=0;i<10;i+=1){if(a.indexOf("{"+i+"}")>=0){s+=" "+(i>=t.length?"{"+i+"}":t[i])}}return s}});e.apply(this)}finally{t.verifyAndRestore()}},isRealOData:function(){if(l==="proxy"){throw new Error("realOData=proxy is no longer supported")}return E},isSupportAssistant:function(){return v},getRealOData:function(){return l?"&realOData="+l:""},getRequestCount:function(){return T},proxy:function(e){t.warning("#proxy is no longer supported",null,"sap.ui.test.TestUtils");return e},resetRequestCount:function(){T=0},retrieveData:function(e){var t=g[e];delete g[e];return t},setData:function(e,t){g[e]=t},setupODataV4Server:function(e,t,r,n,s){var a={};if(this.isRealOData()){return}if(!n){n="/"}else if(n.slice(-1)!=="/"){n+="/"}Object.keys(t).forEach(function(e){var r=h.exec(e),s,i;if(r){s=r[1]||"GET";i=r[2]}else{s="GET";i=e}if(!i.startsWith("/")){i=n+i}a[s+" "+i]=t[e]});x.useFakeServer(e,r||"sap/ui/core/qunit/odata/v4/data",a,s,n!=="/"?n:undefined)}};return x},true);