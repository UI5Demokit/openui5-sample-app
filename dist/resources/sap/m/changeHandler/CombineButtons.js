/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/uid","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/util/ManagedObjectModel"],function(e,t,n){"use strict";var r={};function o(e,t,n,r,o,i,a,u,c){var s="";var l="";var d="";var g=[];var p="$sap.m.flexibility.CombineButtonsModel";var f=sap.ui.getCore().getConfiguration().getRTL();var m=[];return e.reduce(function(e,v,b){var h;var C=b;var I;var y;var P=u.content.buttonsIdForSave[C];var S;var B="$sap.m.flexibility.MenuButtonModel"+C;return e.then(t.getProperty.bind(t,v,"text")).then(function(e){S=e;return t.createControl("sap.m.MenuItem",n,a,P)}).then(function(e){I=e;return t.findIndexInParentAggregation(v)}).then(function(e){c.insertIndexes[C]=e;return t.attachEvent(I,"press","sap.m.changeHandler.CombineButtons.pressHandler",{selector:t.getSelector(v,n),appComponentId:n.getId()})}).then(function(){return t.createControl("sap.ui.fl.util.ManagedObjectModel",n,a,Object.assign({},P,{id:P.id+"-managedObjectModel"}),{object:v,name:p})}).then(function(e){y=e;return t.insertAggregation(I,"dependents",y,0,a)}).then(function(){return t.createControl("sap.ui.core.CustomData",n,a,Object.assign({},P,{id:P.id+"-customData"}),{key:"{ path: '"+p+">key' }",value:"{ path: '"+p+">value' }"})}).then(function(e){t.bindProperty(I,"text",p+">/text");t.bindProperty(I,"icon",p+">/icon");t.bindProperty(I,"enabled",p+">/enabled");t.bindProperty(I,"visible",p+">/visible");return t.bindAggregation(I,"customData",{path:p+">/customData",template:e,templateShareable:false},a)}).then(function(){if(S){f?m.unshift(S):m.push(S)}P.id=P.id+"-originalButtonId";return t.createControl("sap.ui.core.CustomData",n,a,P)}).then(function(e){h=e;t.setProperty(h,"key","originalButtonId");t.setProperty(h,"value",t.getId(v));return t.removeAggregation(o,i,v)}).then(function(){return t.insertAggregation(o,"dependents",v,0,a)}).then(function(){t.insertAggregation(v,"customData",h,0,a)}).then(function(){t.insertAggregation(r,"items",I,C,a)}).then(function(){return t.createControl("sap.ui.fl.util.ManagedObjectModel",n,a,Object.assign({},P,{id:P.id+"-managedObjectModelMenuItem"}),{object:I,name:B})}).then(function(e){g[C]=e;s=s+d+"${"+B+">/enabled}";l=l+d+"${"+B+">/visible}";d=" || ";return{menuButtonModels:g,menuButtonName:m,propertyEnabled:s,propertyVisible:l}})},Promise.resolve())}r.applyChange=function(e,t,n){if(n.modifier.targets!=="jsControlTree"){return Promise.reject(new Error("Combine buttons change can't be applied on XML tree"))}var r=e.getDefinition();var i=n.modifier;var a=n.view;var u=n.appComponent;var c;var s;var l;var d;var g;var p;var f;var m={parentAggregation:"",insertIndexes:[]};var v=[];var b=[];return Promise.resolve().then(i.bySelector.bind(i,r.content.combineButtonSelectors[0],u,a)).then(function(e){s=e;c=i.getParent(s);var t=[];r.content.combineButtonSelectors.forEach(function(e){var n=Promise.resolve().then(i.bySelector.bind(i,e,u,a));t.push(n)});return Promise.all(t)}).then(function(e){g=e;return i.getParentAggregationName(g[0],c)}).then(function(e){d=e;m.parentAggregation=d;return i.findIndexInParentAggregation(s)}).then(function(e){l=e;return i.createControl("sap.m.Menu",u,a,r.content.menuIdSelector)}).then(function(e){p=e;return o(g,i,u,p,c,d,a,r,m)}).then(function(e){v=e.menuButtonModels;b=e.menuButtonName;var t=e.propertyVisible;var n=e.propertyEnabled;return i.createControl("sap.m.MenuButton",u,a,r.content.menuButtonIdSelector,{visible:"{= "+t+"}",enabled:"{= "+n+"}"})}).then(function(e){f=e;return v.reduce(function(e,t){return e.then(i.insertAggregation.bind(i,f,"dependents",t,0,a))},Promise.resolve())}).then(function(){i.setProperty(f,"text",b.join("/"));return Promise.resolve().then(i.insertAggregation.bind(i,f,"menu",p,0,a)).then(i.insertAggregation.bind(i,c,d,f,l,a)).then(function(){e.setRevertData(m)})})};function i(e,t){return e.reduce(function(e,n){return e.then(function(){return t.getProperty(n,"key")}).then(function(e){if(e==="originalButtonId"){return t.destroy(n)}return undefined})},Promise.resolve())}r.revertChange=function(e,t,n){var r=n.modifier;var o=n.view;var a=e.getRevertData();var u=e.getDefinition();var c=a.parentAggregation;var s,l,d;return Promise.resolve().then(function(){return r.bySelector(u.content.menuButtonIdSelector,n.appComponent,o)}).then(function(e){s=e;l=r.getParent(s);d=u.content.combineButtonSelectors.slice().reverse();return r.removeAggregation(l,c,s)}).then(function(){return r.destroy(s)}).then(function(){var t=d.length;return d.reduce(function(e,u,s){var d=s;var g;return e.then(function(){return r.bySelector(u,n.appComponent,o)}).then(function(e){g=e;return r.getAggregation(g,"customData")}).then(function(e){return i(e,r)}).then(function(){return r.insertAggregation(l,c,g,a.insertIndexes[t-d-1],o)})},Promise.resolve()).then(function(){e.resetRevertData()})})};r.completeChangeContent=function(t,n,r){var o=r.modifier;var i=r.appComponent;var a=t.getDefinition();var u=n.combineElementIds;if(u&&u.length>1){t.addDependentControl(u,"combinedButtons",r);a.content.combineButtonSelectors=u.map(function(e){return o.getSelector(e,i)});a.content.menuButtonIdSelector=o.getSelector(i.createId(e()),i);a.content.menuIdSelector=o.getSelector(i.createId(e()),i);a.content.buttonsIdForSave=u.map(function(){return o.getSelector(i.createId(e()),i)})}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineElementIds attribute required")}};r.pressHandler=function(e,r){var o=t.bySelector(r.selector,n.get(r.appComponentId));o.firePress()};return r},true);